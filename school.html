<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>school</title>
    <link href="ext-3.3.0/resources/css/ext-all.css" rel="stylesheet" type="text/css" />
    <script src="ext-3.3.0/adapter/ext/ext-base.js" type="text/javascript"></script>
    <script src="ext-3.3.0/ext-all.js" type="text/javascript"></script>
    <script>
        Ext.onReady(function () {
            Ext.QuickTips.init();

            var currentHandleNode;

            const addNode = (handleNode, nodeText) => {
                if (!handleNode) {
                    return;
                }
                if (handleNode.getDepth() === 2) {
                    handleNode = handleNode.parentNode;
                }
                if (handleNode.childNodes.length === 0) {
                    handleNode.leaf = false;
                    handleNode.expand();
                    handleNode.appendChild(
                        new Ext.tree.TreeNode({
                            text: `${nodeText}`,
                            leaf: true,
                            expanded: true
                        })
                    );
                } else {
                    handleNode.appendChild(
                        new Ext.tree.TreeNode({
                            text: `${nodeText}`,
                            leaf: true,
                            expanded: true
                        })
                    );
                }
            };

            const schoolForm = new Ext.form.FormPanel({
                id: "schoolForm",
                title: "Ê∑ªÂä†",
                frame: true,
                border: false,
                items: [{
                    id: "info",
                    xtype: "textfield",
                    fieldLabel: "ËØ∑Â°´ÂÜôÁõ∏ÂÖ≥‰ø°ÊÅØ",
                    allowBlank: false
                }],
                buttons: [{
                        text: "Êèê‰∫§",
                        handler: function () {
                            if (schoolForm.getForm().isValid()) {
                                if (currentHandleNode) {
                                    addNode(currentHandleNode, schoolForm.findById("info")
                                        .getValue());

                                } else {
                                    Ext.Msg.alert("Ë≠¶Âëä", "ËØ∑ÈÄâÊã©Ë¶ÅÊ∑ªÂä†ÁöÑÁ±ªÂà´");
                                }
                            }
                        }
                    },
                    {
                        text: "ÈáçÁΩÆ",
                        handler: function () {
                            schoolForm.getForm().reset();
                        }
                    }
                ]
            });

            const schoolMenu = new Ext.menu.Menu({
                id: "Amenu",
                items: [{
                        id: "deleteNode",
                        text: "Âà†Èô§"
                    },
                    {
                        id: "addNode",
                        text: "Ê∑ªÂä†"
                    }
                ],
                listeners: {
                    itemclick: function (item) {
                        currentHandleNode = item.parentMenu.contextNode;
                        console.log(currentHandleNode);
                        switch (item.id) {
                            case "deleteNode":
                                if (currentHandleNode.parentNode) {
                                    currentHandleNode.remove();
                                }
                                break;
                            case "addNode":
                                Ext.Msg.prompt('tips', 'ËØ∑ËæìÂÖ•‰ø°ÊÅØ', function (btn, text) {
                                    if (btn === 'ok' && text) {
                                        addNode(currentHandleNode, text);
                                    } else {
                                        Ext.Msg.alert("tips", "ËæìÂÖ•‰∏çËÉΩ‰∏∫Á©∫");
                                    }
                                });
                                break;
                        }
                    }
                }
            });

            const schoolTree = new Ext.tree.TreePanel({
                id: "schoolTree",
                border: false,
                enableDD: true,
                useArrows: true,
                contextMenu: schoolMenu,
                loader: new Ext.tree.TreeLoader({
                    dataUrl: "schoolData.txt"
                }),
                root: new Ext.tree.AsyncTreeNode({
                    text: "üè¶Â≠¶Ê†°",
                    expanded: true
                }),
                listeners: {
                    contextmenu: function (node, e) {
                        node.select();
                        var context = node.getOwnerTree().contextMenu;
                        context.contextNode = node;
                        context.showAt(e.getXY());
                    },
                    click: function (node, event) {
                        currentHandleNode = node;
                    }
                }
            });

            const treeEditor = new Ext.tree.TreeEditor(
                schoolTree, {
                    allowBlank: false
                }, {
                    listeners: {
                        complete: function (editor, curr, old) {
                            Ext.Msg.alert("ÊÇ®Â•Ω", "‰Ω†Êää" + old + "‰øÆÊîπ‰∏∫‰∫Ü" + curr);
                        }
                    }
                }
            );

            const schoolTreeSorter = new Ext.tree.TreeSorter(schoolTree, {
                caseSensitive: true,
                dir: "asc",
                folderSort: true
            })

            new Ext.Panel({
                style: "margin:auto",
                title: "ÊïôÂä°Á≥ªÁªü",
                width: 600,
                border: false,
                frame: true,
                renderTo: "school",
                items: [{
                    xtype: "fieldset",
                    items: [schoolTree]
                }, schoolForm]
            });
        });
    </script>
</head>

<body>
    <div id="school"></div>
</body>

</html>